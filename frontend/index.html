<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' http://localhost:8787 https://solar-planner-api.matthew-declercq.workers.dev https://*.workers.dev; base-uri 'self'; form-action 'self';">
  <title>Solar Planner | Weather & Peak Sun Hours</title>
  <link rel="shortcut icon" href="assets/favicon.ico">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>
<body>
  <div class="background-pattern"></div>
  
  <!-- Login Page -->
  <div id="login-page" x-data="nav()" class="login-page hidden">
    <!-- Navigation -->
    <nav class="nav" role="navigation" aria-label="Main navigation">
      <div class="nav-container">
        <a href="#" class="nav-logo" aria-label="Solar Planner Home">
          <img src="assets/CT_LOGO.webp" alt="Solar Planner Logo" class="nav-logo-img" width="2430" height="874">
        </a>
        <h1 class="nav-title">Solar Planner</h1>
        <div class="nav-actions">
          <button @click="toggleTheme()" class="theme-toggle-btn nav-btn" aria-label="Toggle theme">
            <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"/>
              <line x1="12" y1="1" x2="12" y2="3"/>
              <line x1="12" y1="21" x2="12" y2="23"/>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
              <line x1="1" y1="12" x2="3" y2="12"/>
              <line x1="21" y1="12" x2="23" y2="12"/>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
            <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
          </button>
          <button class="menu-btn nav-btn" aria-label="Open menu" aria-expanded="false">
            <span class="menu-line"></span>
            <span class="menu-line"></span>
            <span class="menu-line"></span>
          </button>
        </div>
      </div>
    </nav>
    <main class="container">
      <div class="login-container">
        <form x-data="loginForm()" @submit.prevent="handleSubmit()" id="login-form" class="login-form">
          <div class="input-wrapper">
            <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <input 
              type="password" 
              id="password-input" 
              x-model="password"
              placeholder="Enter password" 
              autocomplete="current-password"
              required
              autofocus
              :disabled="isLoading"
            >
          </div>
          <button type="submit" id="login-btn" class="submit-btn" :disabled="isLoading">
            <span class="btn-text">Login</span>
            <svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/>
              <polyline points="12 5 19 12 12 19"/>
            </svg>
          </button>
          <div x-show="error" x-cloak id="login-error" class="error-message login-error-spacing">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <p id="login-error-text" x-text="error"></p>
          </div>
        </form>
      </div>
    </main>
  </div>
  
  <!-- Main Application -->
  <div id="main-app" x-data="nav()" class="main-app hidden">
    <!-- Navigation -->
    <nav class="nav" role="navigation" aria-label="Main navigation">
      <div class="nav-container">
        <a href="#" class="nav-logo" aria-label="Solar Planner Home">
          <img src="assets/CT_LOGO.webp" alt="Solar Planner Logo" class="nav-logo-img" width="2430" height="874">
        </a>
        <h1 class="nav-title">Solar Planner</h1>
        <div class="nav-actions">
          <button @click="toggleTheme()" class="theme-toggle-btn nav-btn" aria-label="Toggle theme">
            <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"/>
              <line x1="12" y1="1" x2="12" y2="3"/>
              <line x1="12" y1="21" x2="12" y2="23"/>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
              <line x1="1" y1="12" x2="3" y2="12"/>
              <line x1="21" y1="12" x2="23" y2="12"/>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
            <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
          </button>
          <button class="menu-btn nav-btn" aria-label="Open menu" aria-expanded="false">
            <span class="menu-line"></span>
            <span class="menu-line"></span>
            <span class="menu-line"></span>
          </button>
        </div>
      </div>
    </nav>
    <main class="container">
      <!-- Header -->
      <header class="header">
        <p class="tagline">Comprehensive solar planning: weather analysis, peak sun hours, tilt optimization, and power generation estimates</p>
      </header>

    <!-- Search Section -->
    <section class="search-section">
      <form x-data="locationInput()" @submit.prevent="handleSubmit()" id="search-form" class="search-form">
        <div class="input-wrapper">
          <svg class="location-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          <input 
            type="text" 
            id="location-input" 
            x-model="query"
            @input="search()"
            @focus="showCachedLocations()"
            @keydown="handleKeydown($event)"
            @blur="setTimeout(() => showDropdown = false, 200)"
            placeholder="Enter city or address (e.g., Austin, TX or Guam)" 
            autocomplete="off"
            required
          >
          <div x-show="showDropdown" x-cloak id="autocomplete-dropdown" class="autocomplete-dropdown">
            <template x-if="header">
              <div class="autocomplete-header" x-text="header"></div>
            </template>
            <template x-for="(item, index) in suggestionItems" :key="index">
              <div 
                @click="selectSuggestion(item)"
                :class="['autocomplete-item', { 'selected': item.isSelected }]"
                x-html="item.icon + item.displayEscaped"
              ></div>
            </template>
          </div>
        </div>
        <button type="submit" id="submit-btn" class="submit-btn">
          <span class="btn-text">Get Data</span>
          <svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="5" y1="12" x2="19" y2="12"/>
            <polyline points="12 5 19 12 12 19"/>
          </svg>
        </button>
      </form>
    </section>

    <!-- Loading Spinner -->
    <div id="loading" class="loading hidden">
      <div class="spinner"></div>
      <p>Fetching solar data...</p>
    </div>

    <!-- Error Message -->
    <div id="error" class="error-message hidden">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <p id="error-text"></p>
    </div>

    <!-- Results Container -->
    <div id="results" class="results hidden">
      <!-- Location Info -->
      <div id="location-info" class="location-info">
        <div>
          <h2 id="resolved-location"></h2>
          <p id="coordinates"></p>
          <p id="years-info" class="years-info"></p>
          <p id="cache-info" class="cache-info">
            <span id="cache-info-text"></span>
            <button id="clear-cache-btn" class="clear-cache-link" title="Clear cached data">Clear cache</button>
          </p>
        </div>
      </div>

      <!-- Section 1: Historical Weather -->
      <section class="data-section">
        <div class="section-header">
          <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
              <polyline points="10 9 9 9 8 9"/>
            </svg>
            Historical Weather Averages
          </h3>
          <div class="view-toggle">
            <button class="toggle-btn" data-view="table" data-section="weather" aria-label="Table view">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/>
              </svg>
              Table
            </button>
            <button class="toggle-btn active" data-view="graph" data-section="weather" aria-label="Graph view">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
              </svg>
              Graph
            </button>
          </div>
        </div>

        <!-- Chart Labels -->
        <p class="chart-label" id="weather-label">Historical weather averages are essential for effective solar planning, as they inform optimal insulation requirements and HVAC consumption patterns. Colder periods may necessitate additional heating, while warmer months increase cooling demands—directly impacting overall energy costs and solar system sizing.</p>

        <div class="table-container view-content hidden" data-section="weather" data-view="table">
          <table id="weather-table" class="data-table">
            <thead>
              <tr>
                <th>Month</th>
                <th>High (°F)</th>
                <th>Low (°F)</th>
                <th>Mean (°F)</th>
                <th>Humidity (%)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="chart-container view-content" data-section="weather" data-view="graph">
          <canvas id="weather-chart"></canvas>
        </div>
      </section>

      <!-- Section 2: Solar Peak Sun Hours -->
      <section class="data-section">
        <div class="section-header">
          <div>
            <h3>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="5"/>
                <line x1="12" y1="1" x2="12" y2="3"/>
                <line x1="12" y1="21" x2="12" y2="23"/>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                <line x1="1" y1="12" x2="3" y2="12"/>
                <line x1="21" y1="12" x2="23" y2="12"/>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
              </svg>
              Peak Sun Hours (PSH) & Optimal Panel Tilt Angle
            </h3>
            <p class="section-description">kWh/m²/day on panel surface at different tilt angles</p>
          </div>
          <div class="section-header-actions">
            <div class="view-toggle">
              <button class="toggle-btn" data-view="table" data-section="solar" aria-label="Table view">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/>
                </svg>
                Table
              </button>
              <button class="toggle-btn active" data-view="graph" data-section="solar" aria-label="Graph view">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
                Graph
              </button>
            </div>
            <div class="view-toggle" id="solar-graph-toggle" style="display: none;">
              <button class="toggle-btn active" data-view="psh" data-section="solar-graph" aria-label="PSH graph">
                PSH
              </button>
              <button class="toggle-btn" data-view="tilt" data-section="solar-graph" aria-label="Tilt angle graph">
                Tilt Angle
              </button>
            </div>
          </div>
        </div>

        <!-- Chart Labels -->
        <p class="chart-label" id="solar-psh-label">Peak Sun Hours (PSH) represents the average daily solar energy received per square meter of panel surface. Higher values indicate more solar energy available. Monthly Optimal Tilt adjusts the panel angle each month for maximum energy capture, while Yearly Fixed Tilt uses a constant angle set to the location's latitude.</p>
        <p class="chart-label hidden" id="solar-tilt-label">Tilt angles show the optimal panel orientation for each month. Monthly Optimal Tilt changes throughout the year to track the sun's position, while Yearly Fixed Tilt remains constant at the location's latitude.</p>

        <div class="table-container view-content hidden" data-section="solar" data-view="table">
          <table id="solar-table" class="data-table solar-table">
            <thead>
              <tr>
                <th rowspan="2">Month</th>
                <th colspan="2">Monthly Optimal</th>
                <th colspan="2">Yearly Fixed</th>
                <th>Flat (0°)</th>
              </tr>
              <tr>
                <th>Tilt (°)</th>
                <th>PSH</th>
                <th>Tilt (°)</th>
                <th>PSH</th>
                <th>PSH</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="chart-container view-content" data-section="solar" data-view="graph">
          <canvas id="solar-chart" data-view="psh"></canvas>
          <canvas id="solar-tilt-chart" class="hidden" data-view="tilt"></canvas>
        </div>
      </section>

      <!-- Section 3: Power Generation Calculator -->
      <section class="data-section" id="power-gen-section">
        <div class="section-header">
          <div>
            <h3>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
              </svg>
              Power Generation Calculator
            </h3>
            <p class="section-description">Estimate your solar panel output based on PSH data</p>
          </div>
          <div class="section-header-actions">
            <div class="view-toggle">
              <button class="toggle-btn" data-view="table" data-section="power-gen" aria-label="Table view">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/>
                </svg>
                Table
              </button>
              <button class="toggle-btn active" data-view="graph" data-section="power-gen" aria-label="Graph view">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
                Graph
              </button>
            </div>
            <div class="view-toggle" id="power-gen-view-toggle">
              <button class="toggle-btn active" data-view="daily" data-section="power-gen-view" aria-label="Daily view">
                Daily
              </button>
              <button class="toggle-btn" data-view="monthly" data-section="power-gen-view" aria-label="Monthly view">
                Monthly
              </button>
            </div>
          </div>
        </div>

        <!-- Power Calculator Inputs -->
        <div class="power-calc-inputs">
          <div class="input-group">
            <label for="panel-wattage">Panel Wattage</label>
            <div class="input-with-suffix">
              <input
                type="number"
                id="panel-wattage"
                placeholder="e.g. 400"
                min="1"
                max="100000"
                step="1"
              >
              <span class="input-suffix">W</span>
            </div>
          </div>
        </div>

        <!-- Chart Label -->
        <p class="chart-label" id="power-gen-label">Power generation estimates for each month, comparing Monthly Optimal Tilt, Yearly Fixed Tilt, and Flat (0°) configurations. Table shows daily and monthly values with annual totals at the bottom.</p>

        <!-- Table View -->
        <div class="table-container view-content hidden" data-section="power-gen" data-view="table">
          <table id="power-gen-table" class="data-table">
            <thead>
              <tr>
                <th rowspan="2">Month</th>
                <th colspan="2">Monthly Optimal</th>
                <th colspan="2">Yearly Fixed</th>
                <th colspan="2">Flat (0°)</th>
              </tr>
              <tr>
                <th>Daily (kWh)</th>
                <th>Monthly (kWh)</th>
                <th>Daily (kWh)</th>
                <th>Monthly (kWh)</th>
                <th>Daily (kWh)</th>
                <th>Monthly (kWh)</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr class="total-row">
                <td><strong>Annual Total</strong></td>
                <td colspan="2"><strong id="power-gen-monthly-optimal-total">-</strong></td>
                <td colspan="2"><strong id="power-gen-yearly-fixed-total">-</strong></td>
                <td colspan="2"><strong id="power-gen-flat-total">-</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Monthly Power Generation Chart -->
        <div class="chart-container view-content" id="power-gen-container" data-section="power-gen" data-view="graph">
          <p class="chart-placeholder" id="power-gen-placeholder">Enter your panel wattage above to see estimated power generation</p>
          <canvas id="power-gen-chart" class="hidden"></canvas>
        </div>

        <!-- Hourly Power Generation Chart (hidden by default) -->
        <div class="chart-container hidden" id="hourly-power-container">
          <div class="hourly-header">
            <button id="hourly-back-btn" class="back-btn" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"/>
                <polyline points="12 19 5 12 12 5"/>
              </svg>
              Back to Monthly
            </button>
            <h4 id="hourly-chart-title">Hourly Power Generation</h4>
          </div>
          <canvas id="hourly-power-chart"></canvas>
        </div>
      </section>
    </div>
    </main>

    <footer class="footer">
      <p>Raw weather data from <a href="https://www.visualcrossing.com/" target="_blank" rel="noopener">Visual Crossing Weather</a> API.</p>
      <p>Calculations and Analysis performed by Copper Tech.</p>
      <p>© 2026 Copper Tech LLC. All rights reserved.</p>
    </footer>
  </div>

  <!-- Main application entry point -->
  <script type="module" src="/src/main.ts"></script>
</body>
</html>

